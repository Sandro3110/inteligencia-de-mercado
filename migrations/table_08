CREATE TABLE fato_entidade_contexto (
  id SERIAL PRIMARY KEY,
  entidade_id INTEGER NOT NULL,
  projeto_id INTEGER NOT NULL,
  pesquisa_id INTEGER,
  geografia_id INTEGER,
  mercado_id INTEGER DEFAULT 1,
  status_qualificacao_id INTEGER NOT NULL,
  qualidade_score INTEGER CHECK (qualidade_score BETWEEN 0 AND 100),
  qualidade_classificacao VARCHAR(1) CHECK (qualidade_classificacao IN ('A', 'B', 'C', 'D')),
  faturamento_estimado DECIMAL(15,2),
  num_estabelecimentos INTEGER,
  num_funcionarios INTEGER,
  observacoes TEXT,
  tags TEXT[],
  added_at TIMESTAMP NOT NULL DEFAULT NOW(),
  added_by INTEGER,
  enriched_at TIMESTAMP,
  enriched_by INTEGER,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  created_by INTEGER,
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_by INTEGER,
  FOREIGN KEY (entidade_id) REFERENCES dim_entidade(id) ON DELETE CASCADE,
  FOREIGN KEY (projeto_id) REFERENCES dim_projeto(id) ON DELETE CASCADE,
  FOREIGN KEY (pesquisa_id) REFERENCES dim_pesquisa(id) ON DELETE SET NULL,
  FOREIGN KEY (geografia_id) REFERENCES dim_geografia(id) ON DELETE SET NULL,
  FOREIGN KEY (mercado_id) REFERENCES dim_mercado(id) ON DELETE SET NULL,
  FOREIGN KEY (status_qualificacao_id) REFERENCES dim_status_qualificacao(id) ON DELETE RESTRICT,
  FOREIGN KEY (added_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (enriched_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
  UNIQUE (entidade_id, projeto_id, pesquisa_id)
);

CREATE INDEX idx_fec_entidade ON fato_entidade_contexto(entidade_id);
CREATE INDEX idx_fec_projeto ON fato_entidade_contexto(projeto_id);
CREATE INDEX idx_fec_pesquisa ON fato_entidade_contexto(pesquisa_id) WHERE pesquisa_id IS NOT NULL;
CREATE INDEX idx_fec_geografia ON fato_entidade_contexto(geografia_id) WHERE geografia_id IS NOT NULL;
CREATE INDEX idx_fec_mercado ON fato_entidade_contexto(mercado_id);
CREATE INDEX idx_fec_status ON fato_entidade_contexto(status_qualificacao_id);
CREATE INDEX idx_fec_entidade_projeto ON fato_entidade_contexto(entidade_id, projeto_id);
CREATE INDEX idx_fec_projeto_pesquisa ON fato_entidade_contexto(projeto_id, pesquisa_id);
CREATE INDEX idx_fec_entidade_projeto_pesquisa ON fato_entidade_contexto(entidade_id, projeto_id, pesquisa_id);
CREATE INDEX idx_fec_projeto_status ON fato_entidade_contexto(projeto_id, status_qualificacao_id);
CREATE INDEX idx_fec_projeto_mercado ON fato_entidade_contexto(projeto_id, mercado_id);
CREATE INDEX idx_fec_projeto_geografia ON fato_entidade_contexto(projeto_id, geografia_id);
CREATE INDEX idx_fec_added_at ON fato_entidade_contexto(added_at);
CREATE INDEX idx_fec_enriched_at ON fato_entidade_contexto(enriched_at) WHERE enriched_at IS NOT NULL;
CREATE INDEX idx_fec_qualidade ON fato_entidade_contexto(qualidade_score) WHERE qualidade_score IS NOT NULL;
CREATE INDEX idx_fec_enriquecido ON fato_entidade_contexto(projeto_id, pesquisa_id, qualidade_score) WHERE pesquisa_id IS NOT NULL AND qualidade_score IS NOT NULL;
CREATE INDEX idx_fec_tags ON fato_entidade_contexto USING gin(tags);

-- ============================================================================
-- 9. fato_entidade_produto
-- ============================================================================

