CREATE TABLE fato_entidade_produto (
  id SERIAL PRIMARY KEY,
  entidade_id INTEGER NOT NULL,
  produto_id INTEGER NOT NULL,
  projeto_id INTEGER NOT NULL,
  pesquisa_id INTEGER,
  tipo_relacao VARCHAR(20) CHECK (tipo_relacao IN ('principal', 'secundario', 'complementar')),
  volume_estimado DECIMAL(12,2),
  preco_praticado DECIMAL(12,2),
  added_at TIMESTAMP NOT NULL DEFAULT NOW(),
  added_by INTEGER,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  created_by INTEGER,
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_by INTEGER,
  FOREIGN KEY (entidade_id) REFERENCES dim_entidade(id) ON DELETE CASCADE,
  FOREIGN KEY (produto_id) REFERENCES dim_produto(id) ON DELETE CASCADE,
  FOREIGN KEY (projeto_id) REFERENCES dim_projeto(id) ON DELETE CASCADE,
  FOREIGN KEY (pesquisa_id) REFERENCES dim_pesquisa(id) ON DELETE SET NULL,
  FOREIGN KEY (added_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
  UNIQUE (entidade_id, produto_id, projeto_id, pesquisa_id)
);

CREATE INDEX idx_fep_entidade ON fato_entidade_produto(entidade_id);
CREATE INDEX idx_fep_produto ON fato_entidade_produto(produto_id);
CREATE INDEX idx_fep_projeto ON fato_entidade_produto(projeto_id);
CREATE INDEX idx_fep_pesquisa ON fato_entidade_produto(pesquisa_id) WHERE pesquisa_id IS NOT NULL;
CREATE INDEX idx_fep_entidade_projeto ON fato_entidade_produto(entidade_id, projeto_id);
CREATE INDEX idx_fep_produto_projeto ON fato_entidade_produto(produto_id, projeto_id);
CREATE INDEX idx_fep_tipo ON fato_entidade_produto(tipo_relacao);

-- ============================================================================
-- 10. fato_entidade_competidor
-- ============================================================================

