CREATE TABLE dim_entidade (
  id SERIAL PRIMARY KEY,
  entidade_hash VARCHAR(64) UNIQUE NOT NULL,
  tipo_entidade VARCHAR(20) NOT NULL CHECK (tipo_entidade IN ('cliente', 'lead', 'concorrente')),
  nome VARCHAR(255) NOT NULL,
  nome_fantasia VARCHAR(255),
  cnpj VARCHAR(18) UNIQUE,
  email VARCHAR(255),
  telefone VARCHAR(20),
  site VARCHAR(255),
  num_filiais INTEGER DEFAULT 0,
  num_lojas INTEGER DEFAULT 0,
  num_funcionarios INTEGER,
  origem_tipo VARCHAR(20) NOT NULL CHECK (origem_tipo IN ('importacao', 'ia_prompt', 'api', 'manual')),
  origem_arquivo VARCHAR(255),
  origem_processo VARCHAR(100),
  origem_prompt TEXT,
  origem_confianca INTEGER CHECK (origem_confianca BETWEEN 0 AND 100),
  origem_data TIMESTAMP NOT NULL DEFAULT NOW(),
  origem_usuario_id INTEGER,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  created_by INTEGER,
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_by INTEGER,
  deleted_at TIMESTAMP,
  deleted_by INTEGER,
  FOREIGN KEY (origem_usuario_id) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (deleted_by) REFERENCES users(id) ON DELETE SET NULL
);

CREATE INDEX idx_entidade_hash ON dim_entidade(entidade_hash);
CREATE INDEX idx_entidade_tipo ON dim_entidade(tipo_entidade);
CREATE INDEX idx_entidade_cnpj ON dim_entidade(cnpj) WHERE cnpj IS NOT NULL;
CREATE INDEX idx_entidade_nome ON dim_entidade(nome);
CREATE INDEX idx_entidade_origem_tipo ON dim_entidade(origem_tipo);
CREATE INDEX idx_entidade_origem_data ON dim_entidade(origem_data);
CREATE INDEX idx_entidade_created_at ON dim_entidade(created_at);
CREATE INDEX idx_entidade_updated_at ON dim_entidade(updated_at);
CREATE INDEX idx_entidade_ativo ON dim_entidade(tipo_entidade, created_at) WHERE deleted_at IS NULL;
CREATE INDEX idx_entidade_tipo_origem ON dim_entidade(tipo_entidade, origem_tipo);

-- ============================================================================
-- 2. dim_projeto
-- ============================================================================

