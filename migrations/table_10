CREATE TABLE fato_entidade_competidor (
  id SERIAL PRIMARY KEY,
  entidade_id INTEGER NOT NULL,
  competidor_id INTEGER NOT NULL,
  projeto_id INTEGER NOT NULL,
  pesquisa_id INTEGER,
  nivel_competicao VARCHAR(20) CHECK (nivel_competicao IN ('direto', 'indireto', 'potencial')),
  diferencial_competitivo TEXT,
  added_at TIMESTAMP NOT NULL DEFAULT NOW(),
  added_by INTEGER,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  created_by INTEGER,
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_by INTEGER,
  FOREIGN KEY (entidade_id) REFERENCES dim_entidade(id) ON DELETE CASCADE,
  FOREIGN KEY (competidor_id) REFERENCES dim_entidade(id) ON DELETE CASCADE,
  FOREIGN KEY (projeto_id) REFERENCES dim_projeto(id) ON DELETE CASCADE,
  FOREIGN KEY (pesquisa_id) REFERENCES dim_pesquisa(id) ON DELETE SET NULL,
  FOREIGN KEY (added_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
  UNIQUE (entidade_id, competidor_id, projeto_id, pesquisa_id),
  CHECK (entidade_id != competidor_id)
);

CREATE INDEX idx_feco_entidade ON fato_entidade_competidor(entidade_id);
CREATE INDEX idx_feco_competidor ON fato_entidade_competidor(competidor_id);
CREATE INDEX idx_feco_projeto ON fato_entidade_competidor(projeto_id);
CREATE INDEX idx_feco_pesquisa ON fato_entidade_competidor(pesquisa_id) WHERE pesquisa_id IS NOT NULL;
CREATE INDEX idx_feco_entidade_projeto ON fato_entidade_competidor(entidade_id, projeto_id);
CREATE INDEX idx_feco_competidor_projeto ON fato_entidade_competidor(competidor_id, projeto_id);
CREATE INDEX idx_feco_nivel ON fato_entidade_competidor(nivel_competicao);

-- ============================================================================
-- FIM DA CRIAÇÃO DE ESTRUTURA
-- ============================================================================
