CREATE TABLE dim_pesquisa (
  id SERIAL PRIMARY KEY,
  projeto_id INTEGER NOT NULL,
  nome VARCHAR(255) NOT NULL,
  descricao TEXT,
  objetivo TEXT,
  status VARCHAR(20) NOT NULL DEFAULT 'pendente' CHECK (status IN ('pendente', 'em_progresso', 'concluida', 'falhou', 'cancelada')),
  total_entidades INTEGER DEFAULT 0,
  entidades_enriquecidas INTEGER DEFAULT 0,
  entidades_falhadas INTEGER DEFAULT 0,
  qualidade_media DECIMAL(5,2),
  started_at TIMESTAMP,
  started_by INTEGER,
  completed_at TIMESTAMP,
  duration_seconds INTEGER,
  error_message TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  created_by INTEGER NOT NULL,
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_by INTEGER,
  deleted_at TIMESTAMP,
  deleted_by INTEGER,
  FOREIGN KEY (projeto_id) REFERENCES dim_projeto(id) ON DELETE CASCADE,
  FOREIGN KEY (started_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (updated_by) REFERENCES users(id) ON DELETE SET NULL,
  FOREIGN KEY (deleted_by) REFERENCES users(id) ON DELETE SET NULL,
  UNIQUE (nome, projeto_id)
);

CREATE INDEX idx_pesquisa_projeto ON dim_pesquisa(projeto_id);
CREATE INDEX idx_pesquisa_status ON dim_pesquisa(status);
CREATE INDEX idx_pesquisa_started_at ON dim_pesquisa(started_at);
CREATE INDEX idx_pesquisa_completed_at ON dim_pesquisa(completed_at);
CREATE INDEX idx_pesquisa_created_at ON dim_pesquisa(created_at);
CREATE INDEX idx_pesquisa_ativa ON dim_pesquisa(projeto_id, status) WHERE deleted_at IS NULL;
CREATE INDEX idx_pesquisa_projeto_status ON dim_pesquisa(projeto_id, status);

-- ============================================================================
-- 4. dim_geografia
-- ============================================================================

